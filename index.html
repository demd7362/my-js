<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Sorter</title>
    <style>
      header {
        text-align: center;
        margin: 0px 30px;
      }

      .flex-container {
        display: flex;
        flex-flow: wrap;
        justify-content: center;
      }

      .flex-child {
        margin: 15px 30px;
      }

      img {
        position: fixed;
        top : 0;
        width: 100%;
        height: 100%;
      }
      .area {
        width: 700px;
        height: 700px;
        border: 1px solid black;
        border-radius: 3px;
        overflow-y: auto;
      }
      [id*=Cnt]{
        text-align: center;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Data Sorter</h1>
      <p>Java VO 또는 JSON을 입력하세요...</p>
      <span id="howToUse">사용 방법</span>
    </header>
    <div class="flex-container">
      <div class="flex-child">
        <label for="input">Original</label>
        <div class="area" contenteditable="true" id="input"></div>
        <div id="inputCnt"></div>
      </div>
      <div class="flex-child">
        <label for="output">Output</label>
        <input type="checkbox" id="change">
        <label for="change">Show Invalid Values</label>
        <div class="area" contenteditable="false" id="output" disabled></div>
        <div id="outputCnt"></div>
      </div>
    </div>
    <img style="display: none;"src="https://user-images.githubusercontent.com/115058411/229290840-ce6c6b81-78f5-4f14-9cfa-823577fee749.png">
    <script>
        let isChecked = false;
        let html = '';
        let filtered = '';
        const output = document.getElementById('output');
        const input = document.getElementById('input');
        const outputCnt = document.getElementById('outputCnt');
        const inputCnt = document.getElementById('inputCnt');
        let truthy = 0;
        let falsy = 0;
        const bracketRemover = (bracket) => {
            const otherBracket = bracket === '(' ? ')' : '}';
            html = html.substring(html.lastIndexOf(bracket)+1).replaceAll(otherBracket,'');
            filtered = filtered.substring(filtered.lastIndexOf(bracket)+1).replaceAll(otherBracket,''); 
        }
        const setDefault = () => {
            html = '';
            filtered = '';
            truthy = 0;
            falsy = 0;
        }
        const setCount = (truthy,falsy) => {
            inputCnt.innerHTML = `<b>${truthy+falsy}개</b>`;
            outputCnt.innerHTML = `<b>${isChecked? falsy : truthy}개</b>`;
        }
        const checker = {
            parseVO(data){
                const arr = data.split(',');
                for (const val of arr) { 
                    const idx = val.indexOf('=');
                    if (!val.includes('null') && val.substring(val.indexOf('=') + 1).trim()) { // 
                        html += `${val.substring(0,idx)} : <b>${val.substring(idx+1)}</b><br>`;
                        truthy++;
                    } else {
                        filtered += `${val.substring(0,idx)} : <b>${val.substring(idx+1)}</b><br>`;
                        falsy++;
                    }
                } // end of for
                bracketRemover('(');
                setCount(truthy,falsy);
            },
            parseObject(data){
                
                try {
                    data = JSON.parse(data);
                } catch (e){
                    console.log(data)
                    const arr = data.split(',');
                    for(const val of arr){
                        const idx = val.indexOf(':');
                        if(!(val.includes('null') || val.includes('" "'))){
                            html += `${val.substring(0,idx)} : <b>${val.substring(idx+1)}</b><br>`;
                            truthy++;
                        } else {
                            filtered += `${val.substring(0,idx)} : <b>${val.substring(idx+1)}</b><br>`;
                            falsy++;
                        }
                    }
                    bracketRemover('{');
                    setCount(truthy,falsy);
                    return;
                }
                for(const [K,V] of Object.entries(data)){     
                    if(String(V).trim() && !String(V).includes('null')){ // 0은 falsy이기 때문에 String으로 변환
                        html += `${K} : <b>${V}</b><br>`;
                        truthy++;
                    } else {
                        filtered += `${K} : <b>${V}</b><br>`;
                        falsy++;
                    }
                }
                setCount(truthy,falsy);
            } 
        }
        
        input.addEventListener('input',function(){
            convert.call(this)
        });
        const convert = function() {
            setDefault();
            const key = this.innerText.includes('VO') ? 'parseVO' : 'parseObject';
            checker[key](this.innerText);
            output.innerHTML = isChecked? filtered : html;
        } 
        const howToUse = document.getElementById('howToUse');
        howToUse.addEventListener('mouseover',function(){
            this.style.fontWeight = 'bold';
            this.style.cursor = 'pointer';
        });
        howToUse.addEventListener('mouseout',function(){
            this.style.fontWeight = 'normal';
        });
        howToUse.addEventListener('click',function(){
            document.querySelector('img').style.display = '';
        });
        document.querySelector('img').addEventListener('click',function(){
            this.style.display = 'none';
        });
        document.getElementById('change').addEventListener('change',function(){
            isChecked = this.checked;
            output.innerHTML = isChecked ? filtered : html;
            setCount(truthy,falsy);
            // const input = document.getElementById('input');
            // convert.call(input);
        });
        
    </script>
  </body>
</html>
